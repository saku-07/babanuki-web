<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ãƒãƒæŠœã Ultimate</title>
<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:sans-serif;
  background:#0f172a;
  color:white;
}
.wrap{max-width:900px;margin:auto;padding:15px}
.hidden{display:none}
.panel{
  background:rgba(255,255,255,0.08);
  padding:15px;
  border-radius:16px;
  margin-top:12px;
}
.btn{
  padding:10px 14px;
  border-radius:12px;
  border:none;
  cursor:pointer;
  background:#2563eb;
  color:white;
}
.card{
  width:70px;height:100px;
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:white;
  color:black;
  font-weight:bold;
}
.back{background:#334155;color:white;cursor:pointer}
.hand{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}

/* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.7);
  display:flex;
  align-items:center;
  justify-content:center;
}
.overlayBox{
  background:#1e293b;
  padding:20px;
  border-radius:16px;
  text-align:center;
}
</style>
</head>
<body>

<div id="menu" class="wrap">
  <h1>ãƒãƒæŠœã</h1>
  <label>äººæ•°:
    <select id="players">
      <option>2</option>
      <option>3</option>
      <option selected>4</option>
      <option>5</option>
    </select>
  </label>
  <br><br>
  <button class="btn" onclick="startGame()">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
</div>

<div id="game" class="wrap hidden">
  <div class="panel">
    <div id="message"></div>
  </div>

  <div class="panel">
    <h3 id="turnTitle"></h3>
    <div class="hand" id="myHand"></div>
  </div>

  <div class="panel">
    <h3>æ¬¡ã®äººã®ã‚«ãƒ¼ãƒ‰</h3>
    <div class="hand" id="targetHand"></div>
  </div>

  <button class="btn" onclick="goMenu()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸</button>
</div>

<!-- å¼•ã„ãŸã‚«ãƒ¼ãƒ‰è¡¨ç¤º -->
<div id="reveal" class="overlay hidden">
  <div class="overlayBox">
    <h2>å¼•ã„ãŸã‚«ãƒ¼ãƒ‰</h2>
    <div id="revealCard" class="card" style="margin:auto"></div>
    <p id="revealResult"></p>
    <button class="btn" onclick="finishReveal()">OK</button>
  </div>
</div>

<script>
let game=null;

function startGame(){
  const count=parseInt(document.getElementById("players").value);
  const deck=makeDeck();
  const players=[];
  for(let i=0;i<count;i++){
    players.push({name:"ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼"+(i+1),hand:[]});
  }
  let idx=0;
  while(deck.length){
    players[idx].hand.push(deck.pop());
    idx=(idx+1)%players.length;
  }
  players.forEach(p=>discardPairs(p.hand));
  game={players,turn:0,finished:false};
  document.getElementById("menu").classList.add("hidden");
  document.getElementById("game").classList.remove("hidden");
  render();
}

function goMenu(){
  document.getElementById("game").classList.add("hidden");
  document.getElementById("menu").classList.remove("hidden");
}

function makeDeck(){
  const suits=["â™ ","â™¥","â™¦","â™£"];
  const ranks=["A","2","3","4","5","6","7","8","9","10","J","Q","K"];
  const deck=[];
  for(const s of suits)for(const r of ranks)deck.push({s,r});
  deck.push({s:"",r:"Joker"});
  return deck.sort(()=>Math.random()-0.5);
}

function discardPairs(hand){
  const count={};
  hand.forEach(c=>{
    if(c.r!=="Joker"){
      count[c.r]=(count[c.r]||0)+1;
    }
  });
  for(const r in count){
    if(count[r]>=2){
      let removed=0;
      for(let i=hand.length-1;i>=0;i--){
        if(hand[i].r===r && removed<2){
          hand.splice(i,1);
          removed++;
        }
      }
    }
  }
}

function render(){
  const current=game.players[game.turn];
  const next=game.players[(game.turn+1)%game.players.length];

  document.getElementById("turnTitle").innerText=
    current.name+" ã®æ‰‹ç•ª";

  const myHand=document.getElementById("myHand");
  myHand.innerHTML="";
  current.hand.forEach(c=>{
    const div=document.createElement("div");
    div.className="card";
    div.innerText=c.r==="Joker"?"ğŸƒ":c.s+c.r;
    myHand.appendChild(div);
  });

  const targetHand=document.getElementById("targetHand");
  targetHand.innerHTML="";
  next.hand.forEach((c,i)=>{
    const div=document.createElement("div");
    div.className="card back";
    div.innerText="ğŸ‚ ";
    div.onclick=()=>drawCard(i);
    targetHand.appendChild(div);
  });
}

let pendingCard=null;

function drawCard(index){
  const current=game.players[game.turn];
  const next=game.players[(game.turn+1)%game.players.length];
  const card=next.hand.splice(index,1)[0];
  current.hand.push(card);
  pendingCard=card;

  const matched=current.hand.filter(c=>c.r===card.r && c.r!=="Joker").length>=2;

  document.getElementById("revealCard").innerText=
    card.r==="Joker"?"ğŸƒ":card.s+card.r;

  document.getElementById("revealResult").innerText=
    matched?"ãã‚ã£ãŸï¼":"ãã‚ã£ã¦ãªã„";

  document.getElementById("reveal").classList.remove("hidden");
}

function finishReveal(){
  const current=game.players[game.turn];
  discardPairs(current.hand);

  if(current.hand.length===0){
    alert(current.name+" ã‚ãŒã‚Šï¼");
  }

  game.turn=(game.turn+1)%game.players.length;

  document.getElementById("reveal").classList.add("hidden");
  render();
}
</script>

</body>
</html>
