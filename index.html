<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ãƒãƒæŠœã</title>
  <meta name="theme-color" content="#0b1220"/>
  <style>
    *{box-sizing:border-box}
    :root{
      --bg:#0b1220;
      --panel:rgba(255,255,255,.08);
      --text:#e8eefc;
      --muted:rgba(232,238,252,.74);
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
      --a: rgba(88,153,255,.9);
      --b: rgba(142,92,255,.9);
    }
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 700px at 20% 10%, #1b2b55, var(--bg));
      overflow-x:hidden;
    }
    .bgAnim{
      position:fixed; inset:0; pointer-events:none;
      background:
        radial-gradient(400px 300px at 80% 20%, rgba(255,255,255,.08), transparent 60%),
        radial-gradient(600px 400px at 30% 70%, rgba(255,255,255,.06), transparent 60%);
      animation: drift 10s ease-in-out infinite alternate;
    }
    @keyframes drift{ from{transform:translate3d(0,0,0)} to{transform:translate3d(10px,-12px,0)} }

    .wrap{ max-width:980px; margin:0 auto; padding:14px; }
    .hero{
      display:flex; gap:14px; align-items:center;
      padding:18px;
      border-radius:var(--radius);
      background: linear-gradient(135deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      box-shadow:var(--shadow);
    }
    .logo{
      width:52px; height:52px; display:grid; place-items:center;
      font-size:30px;
      background: rgba(255,255,255,.12);
      border-radius:16px;
      user-select:none;
    }
    .heroText h1{ margin:0; font-size:26px; }
    .heroText p{ margin:4px 0 0; color:var(--muted); font-size:13px; }

    .panel{
      margin-top:14px;
      padding:16px;
      border-radius:var(--radius);
      background:var(--panel);
      box-shadow:var(--shadow);
      backdrop-filter: blur(8px);
    }
    .panel h2{ margin:0 0 10px; font-size:18px; }
    .panel h3{ margin:14px 0 8px; font-size:16px; }

    .steps{ margin:0; padding-left:18px; color:var(--muted); }
    .steps li{ margin:8px 0; }

    .grid3{ display:grid; grid-template-columns: repeat(3,1fr); gap:10px; }
    .field span{ display:block; font-size:13px; color:var(--muted); margin-bottom:6px; }

    select, input[type="text"]{
      width:100%;
      padding:12px;
      border-radius:14px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.25);
      color: var(--text);
      outline:none;
    }

    .btn{
      border:0;
      border-radius:14px;
      padding:12px 14px;
      cursor:pointer;
      font-size:14px;
      color:var(--text);
      background: rgba(255,255,255,.12);
      transition: transform .08s ease, filter .2s ease;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn.primary{
      width:100%;
      margin-top:12px;
      background: linear-gradient(135deg, var(--a), var(--b));
      box-shadow: 0 12px 30px rgba(88,153,255,.25);
    }
    .btn.ghost{
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.14);
    }

    .note{
      margin-top:12px;
      padding:10px 12px;
      border-radius:14px;
      background: rgba(255,255,255,.06);
      color:var(--muted);
      display:flex; gap:10px; align-items:flex-start;
    }
    .note.small{ font-size:12px; }
    .tag{
      flex:0 0 auto;
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      background: rgba(255,255,255,.12);
      color: var(--text);
    }

    .topbar{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
      padding:14px 16px;
      border-radius:var(--radius);
      background: rgba(255,255,255,.08);
      box-shadow:var(--shadow);
      margin-top:10px;
    }
    .title .mini{ font-weight:800; }
    .title .sub{ font-size:12px; color:var(--muted); margin-top:2px; }

    .msg{
      padding:10px 12px;
      border-radius:14px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.10);
      line-height:1.6;
    }

    .statusGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      margin-top:10px;
    }
    .pStat{
      padding:10px 12px;
      border-radius:14px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
    }
    .pName{ font-weight:800; }
    .pMeta{ color:var(--muted); margin-top:4px; font-size:13px; }

    .hand{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }

    .card{
      width:74px;
      height:102px;
      border-radius:16px;
      display:grid;
      place-items:center;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 10px 24px rgba(0,0,0,.24);
      user-select:none;
      transition: transform .12s ease, filter .2s ease;
    }
    .card:hover{ filter: brightness(1.06); }
    .card:active{ transform: translateY(1px) scale(.99); }
    .faceUp .rank{ font-weight:900; padding: 0 8px; text-align:center; }

    .back{
      background: linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      cursor:pointer;
    }
    .backMark{ font-size:28px; opacity:.95; }

    .hintBox{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      background: rgba(88,153,255,.12);
      border: 1px solid rgba(88,153,255,.22);
      display:flex; gap:10px;
    }

    .bigLose{
      font-size:18px;
      padding:12px 14px;
      border-radius:14px;
      background: rgba(255,255,255,.08);
      line-height:1.6;
    }

    .flashIn{ animation: flashIn .25s ease-out; }
    @keyframes flashIn{ from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)} }

    .cpuThinking{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--muted);
    }

    /* ===== PVPãƒ­ãƒƒã‚¯ï¼ˆè¦—ãè¦‹é˜²æ­¢ï¼‰ ===== */
    .lockOverlay{
      position:fixed;
      inset:0;
      z-index:9999;
      display:grid;
      place-items:center;
      padding:14px;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
    }
    .lockCard{
      width: min(520px, 100%);
      border-radius:var(--radius);
      padding:16px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: var(--shadow);
      text-align:center;
    }
    .lockTitle{ font-size:20px; font-weight:900; }
    .lockText{ margin-top:10px; color:var(--muted); line-height:1.6; }

    /* ===== ã‚­ãƒ£ãƒ©ï¼ˆæ‰‹ä¼¸ã°ã—åŒæœŸï¼‰ ===== */
    .arena{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    .character{
      border-radius:var(--radius);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      padding:12px;
      display:flex;
      gap:12px;
      align-items:center;
      min-height:120px;
      overflow:hidden;
    }
    .chMeta{ flex:1; }
    .chName{ font-weight:900; }
    .chState{ margin-top:4px; color:var(--muted); font-size:12px; }

    .chAvatar{
      width:92px; height:92px; flex:0 0 auto;
      filter: drop-shadow(0 12px 18px rgba(0,0,0,.35));
    }
    .character.idle .chAvatar{ animation: breathe 1.8s ease-in-out infinite; }
    @keyframes breathe{ 0%,100%{transform:translateY(0) scale(1)} 50%{transform:translateY(-2px) scale(1.01)} }

    .character .arm{ transform-origin: 20px 58px; }
    .character.reach .arm{
      animation: reachArm .45s cubic-bezier(.2,.9,.2,1) 1;
    }
    @keyframes reachArm{
      0%{ transform: rotate(0deg) translateX(0); }
      55%{ transform: rotate(-22deg) translateX(8px); }
      100%{ transform: rotate(-8deg) translateX(3px); }
    }
    .character.react{ animation: reactHit .30s ease-out 1; }
    @keyframes reactHit{
      0%{ transform: translateX(0); }
      40%{ transform: translateX(-4px); }
      100%{ transform: translateX(0); }
    }

    /* ===== å¼•ãã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼šã‚«ãƒ¼ãƒ‰ãŒé£›ã¶ ===== */
    .flyCard{
      position: fixed;
      left: -9999px;
      top: -9999px;
      width: 74px;
      height: 102px;
      border-radius: 16px;
      display: grid;
      place-items: center;
      font-size: 28px;
      background: linear-gradient(135deg, rgba(255,255,255,.16), rgba(255,255,255,.06));
      border: 1px solid rgba(255,255,255,.20);
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
      z-index: 10000;
      opacity: 0;
      pointer-events: none;
      transform: translate3d(0,0,0) rotate(0deg) scale(1);
    }
    .flyCard.play{
      opacity: 1;
      animation: flyMove .45s cubic-bezier(.2,.9,.2,1) forwards;
    }
    @keyframes flyMove{
      0%{ transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
      60%{ transform: translate3d(calc(var(--dx) * .6), calc(var(--dy) * .6), 0) rotate(18deg) scale(1.06); }
      100%{ transform: translate3d(var(--dx), var(--dy), 0) rotate(8deg) scale(.96); opacity: 0; }
    }

    /* ç”»é¢åˆ‡æ›¿ */
    .hidden{ display:none !important; }

    /* ===== è¿½åŠ ï¼šå¼•ã„ãŸã‚«ãƒ¼ãƒ‰ç¢ºèªï¼ˆãƒªãƒ“ãƒ¼ãƒ«ï¼‰ã‚¢ãƒ‹ãƒ¡ ===== */
    .revealWrap{
      margin-top:12px;
      display:flex;
      justify-content:center;
    }
    .revealCard3d{
      width: 110px;
      height: 150px;
      perspective: 900px;
    }
    .revealCardInner{
      width:100%; height:100%;
      position:relative;
      transform-style:preserve-3d;
      transform: rotateY(180deg);
      transition: transform .42s cubic-bezier(.2,.9,.2,1);
      filter: drop-shadow(0 18px 26px rgba(0,0,0,.38));
    }
    .revealOverlay.show .revealCardInner{
      transform: rotateY(0deg);
    }
    .revealFace{
      position:absolute; inset:0;
      backface-visibility:hidden;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.18);
      display:grid;
      place-items:center;
    }
    .revealBack{
      transform: rotateY(180deg);
      background: linear-gradient(135deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      font-size: 34px;
    }
    .revealFront{
      background: rgba(0,0,0,.22);
      font-size: 22px;
      font-weight: 900;
      padding: 10px;
      text-align:center;
      line-height:1.2;
    }

    .popIn{ animation: popIn .22s ease-out; }
    @keyframes popIn{ from{transform:translateY(8px) scale(.98); opacity:0} to{transform:translateY(0) scale(1); opacity:1} }

    /* ã‚¹ãƒãƒ› */
    @media (max-width: 720px){
      .grid3{ grid-template-columns: 1fr; }
      .statusGrid{ grid-template-columns: 1fr; }
      .arena{ grid-template-columns: 1fr; }
      .card{ width:64px; height:92px; }
      .flyCard{ width:64px; height:92px; }
      .chAvatar{ width:84px; height:84px; }
      .heroText h1{ font-size:22px; }
      .revealCard3d{ width: 100px; height: 140px; }
      .revealFront{ font-size: 20px; }
    }
  </style>
</head>
<body>
  <div class="bgAnim"></div>

  <!-- é£›ã¶ã‚«ãƒ¼ãƒ‰ -->
  <div id="flyCard" class="flyCard" aria-hidden="true">ğŸ‚ </div>

  <!-- PVPãƒ­ãƒƒã‚¯ -->
  <div id="lockOverlay" class="lockOverlay hidden" aria-hidden="true">
    <div class="lockCard flashIn">
      <div class="lockTitle">æ¬¡ã®äººã«æ¸¡ã—ã¦ã­</div>
      <div class="lockText" id="lockText">æ‰‹ç•ªï¼š---</div>
      <button class="btn primary" id="unlockBtn" type="button">ğŸ‘€ è§£é™¤ï¼ˆè¦‹ã‚‹ï¼‰</button>
      <div class="note small" style="margin-top:10px;">
        <span class="tag">PVP</span>
        å¼•ã„ãŸã‚‰è‡ªå‹•ã§å†ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã™ã€‚
      </div>
    </div>
  </div>

  <!-- âœ… è¿½åŠ ï¼šå¼•ã„ãŸã‚«ãƒ¼ãƒ‰ç¢ºèªï¼ˆãƒªãƒ“ãƒ¼ãƒ«ï¼‰ -->
  <div id="revealOverlay" class="lockOverlay hidden revealOverlay" aria-hidden="true">
    <div class="lockCard popIn">
      <div class="lockTitle">å¼•ã„ãŸã‚«ãƒ¼ãƒ‰ã‚’ç¢ºèª</div>

      <div class="revealWrap">
        <div class="revealCard3d">
          <div id="revealInner" class="revealCardInner" aria-hidden="true">
            <div class="revealFace revealBack">ğŸ‚ </div>
            <div class="revealFace revealFront" id="revealCardText">â™ A</div>
          </div>
        </div>
      </div>

      <div class="lockText" id="revealResultText" style="margin-top:12px;">---</div>

      <button class="btn primary" id="revealOkBtn" type="button">OKï¼ˆæ¬¡ã®ç•ªã¸ï¼‰</button>

      <div class="note small" style="margin-top:10px;">
        <span class="tag">èª¬æ˜</span>
        OKã‚’æŠ¼ã™ã¾ã§ãƒšã‚¢å‡¦ç†ï¼†ã‚¿ãƒ¼ãƒ³ç§»å‹•ã—ã¾ã›ã‚“ï¼ˆç¢ºèªã—ã¦ã‹ã‚‰æ¬¡ã¸ï¼‰ã€‚
      </div>
    </div>
  </div>

  <!-- MENU -->
  <div id="viewMenu" class="wrap">
    <header class="hero">
      <div class="logo">ğŸ‚¡</div>
      <div class="heroText">
        <h1>ğŸ‚¡ã€€ãƒãƒæŠœãã€€ğŸ‚¡</h1>
        <p></p>
      </div>
    </header>

    <section class="panel">
      <h2>éŠã³æ–¹</h2>
      <ol class="steps">
        <li>æœ€åˆã«åŒã˜æ•°å­—ã®ãƒšã‚¢ã¯è‡ªå‹•ã§æ¨ã¦ã‚‰ã‚Œã¾ã™ã€‚</li>
        <li>æ‰‹ç•ªã®äººã¯ã€æ¬¡ã®äººã®<b>è£ã‚«ãƒ¼ãƒ‰</b>ã‚’1æšã‚¿ãƒƒãƒ—ã—ã¦å¼•ãã¾ã™ã€‚</li>
        <li><b>å¼•ã„ãŸã‚«ãƒ¼ãƒ‰ã‚’ç¢ºèª</b> â†’ ãã‚ã£ãŸ/ãã‚ã£ã¦ãªã„ ã‚’è¦‹ã¦OKã‚’æŠ¼ã™ã€‚</li>
        <li>OKå¾Œã«ãƒšã‚¢ãŒè‡ªå‹•ã§æ¨ã¦ã‚‰ã‚Œã€æ¬¡ã®äººã®ç•ªã«ãªã‚Šã¾ã™ã€‚</li>
        <li>æœ€å¾Œã«ã‚«ãƒ¼ãƒ‰ã‚’æŒã£ã¦ã„ã‚‹äººï¼ˆã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼æŒã¡ï¼‰ãŒè² ã‘ï¼</li>
      </ol>
      <div class="note small">
        <span class="tag">æ¼”å‡º</span>
        è£ã‚«ãƒ¼ãƒ‰ã‚’æŠ¼ã™ â†’ ã€Œæ‰‹ä¼¸ã°ã—ã€ï¼‹ã€Œã‚«ãƒ¼ãƒ‰é£›ã¶ã€ï¼‹ã€Œå¼•ã„ãŸã‚«ãƒ¼ãƒ‰ç¢ºèªï¼ˆãƒ•ãƒªãƒƒãƒ—ï¼‰ã€ãŒå‡ºã¾ã™ã€‚
      </div>
    </section>

    <section class="panel">
      <h2>è¨­å®š</h2>
      <div class="grid3">
        <label class="field">
          <span>äººæ•°ï¼ˆ2ã€œ5ï¼‰</span>
          <select id="playersSel">
            <option value="2">2äºº</option>
            <option value="3">3äºº</option>
            <option value="4" selected>4äºº</option>
            <option value="5">5äºº</option>
          </select>
        </label>

        <label class="field">
          <span>ãƒ¢ãƒ¼ãƒ‰</span>
          <select id="modeSel">
            <option value="CPU" selected>CPå¯¾æˆ¦</option>
            <option value="PVP">å¯¾äººæˆ¦ï¼ˆåŒã˜ç«¯æœ«ã§äº¤ä»£ï¼‰</option>
          </select>
        </label>

        <label class="field">
          <span>CPå¼·ã•</span>
          <select id="diffSel">
            <option value="EASY">å¼±ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰</option>
            <option value="NORMAL" selected>ä¸­ï¼ˆåŸºæœ¬ï¼‰</option>
            <option value="HARD">å¼·ï¼ˆãƒšã‚¢ç‹™ã„ï¼‰</option>
            <option value="ONI">é¬¼ï¼ˆãƒãƒ¼ãƒˆç´šï¼‰</option>
          </select>
        </label>
      </div>

      <button class="btn primary" id="startBtn" type="button">â–¶ ã‚²ãƒ¼ãƒ é–‹å§‹</button>

      <div class="note small">
        <span class="tag">ä¿å­˜</span>
        è¨­å®šã¯ã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆlocalStorageï¼‰ã€‚
      </div>
    </section>

    <footer class="panel">
      <small style="color:var(--muted)">â€» GitHub Pagesã¯ã‚µãƒ¼ãƒãƒ¼ãªã—ï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ãƒ»ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¯æœªå®Ÿè£…ï¼‰ã€‚</small>
    </footer>
  </div>

  <!-- GAME -->
  <div id="viewGame" class="wrap hidden">
    <header class="topbar">
      <div class="title">
        <div class="mini">ğŸ‚¡ ãƒãƒæŠœã</div>
        <div class="sub" id="subTitle">ãƒ¢ãƒ¼ãƒ‰ï¼š- / å¼·ã•ï¼š-</div>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn ghost" id="lockNowBtn" type="button">ğŸ”’ ã„ã¾ãƒ­ãƒƒã‚¯</button>
        <button class="btn ghost" id="menuBtn" type="button">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸</button>
      </div>
    </header>

    <section class="panel flashIn">
      <h2>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h2>
      <div class="msg" id="msgBox">---</div>
      <div class="statusGrid" id="statusGrid"></div>
    </section>

    <section class="panel flashIn">
      <h2>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h2>
      <div class="arena">
        <div class="character idle" id="ch-me">
          <svg class="chAvatar" viewBox="0 0 100 100" aria-label="ç¾åœ¨ã®æ‰‹ç•ª">
            <circle cx="50" cy="38" r="22" fill="rgba(255,255,255,.14)" stroke="rgba(255,255,255,.25)" />
            <path d="M25 92c4-22 16-32 25-32s21 10 25 32"
                  fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.22)"/>
            <circle class="eye" cx="42" cy="35" r="3.2" fill="rgba(232,238,252,.92)"/>
            <circle class="eye" cx="58" cy="35" r="3.2" fill="rgba(232,238,252,.92)"/>
            <path class="mouth" d="M42 46 Q50 52 58 46"
                  fill="none" stroke="rgba(232,238,252,.92)" stroke-width="2.4" stroke-linecap="round"/>
            <g class="arm">
              <path d="M28 60 Q40 54 52 58" fill="none" stroke="rgba(232,238,252,.90)" stroke-width="5" stroke-linecap="round"/>
              <circle cx="52" cy="58" r="3.6" fill="rgba(232,238,252,.90)"/>
            </g>
          </svg>
          <div class="chMeta">
            <div class="chName" id="meName">æ‰‹ç•ª</div>
            <div class="chState" id="meState">å¾…æ©Ÿ</div>
          </div>
        </div>

        <div class="character idle" id="ch-next">
          <svg class="chAvatar" viewBox="0 0 100 100" aria-label="æ¬¡ã®äºº">
            <circle cx="50" cy="38" r="22" fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.22)" />
            <path d="M25 92c4-22 16-32 25-32s21 10 25 32"
                  fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.20)"/>
            <circle class="eye" cx="42" cy="35" r="3.2" fill="rgba(232,238,252,.88)"/>
            <circle class="eye" cx="58" cy="35" r="3.2" fill="rgba(232,238,252,.88)"/>
            <path class="mouth" d="M42 47 Q50 44 58 47"
                  fill="none" stroke="rgba(232,238,252,.88)" stroke-width="2.4" stroke-linecap="round"/>
            <g class="arm">
              <path d="M72 60 Q60 54 48 58" fill="none" stroke="rgba(232,238,252,.80)" stroke-width="5" stroke-linecap="round"/>
              <circle cx="48" cy="58" r="3.6" fill="rgba(232,238,252,.80)"/>
            </g>
          </svg>
          <div class="chMeta">
            <div class="chName" id="nextName">æ¬¡ã®äºº</div>
            <div class="chState" id="nextState">å¾…æ©Ÿ</div>
          </div>
        </div>
      </div>

      <div class="note small">
        <span class="tag">æ“ä½œ</span>
        äººé–“ã®ç•ªï¼šè£ã‚«ãƒ¼ãƒ‰ã‚’1æšã‚¿ãƒƒãƒ— â†’ å¼•ã„ãŸã‚«ãƒ¼ãƒ‰ç¢ºèª â†’ OKã§æ¬¡ã®ç•ªã¸ã€‚
      </div>
    </section>

    <section class="panel flashIn" id="resultPanel" style="display:none;">
      <h2>çµæœ</h2>
      <div class="bigLose" id="resultText">---</div>
      <button class="btn primary" id="restartBtn" type="button">ã‚‚ã†ä¸€å›</button>
    </section>

    <section class="panel flashIn" id="cpuPanel" style="display:none;">
      <h2>CPUã®ç•ª</h2>
      <div class="cpuThinking" id="cpuThinking">CPUãŒè€ƒãˆä¸­...</div>
    </section>

    <section class="panel flashIn" id="humanPanel" style="display:none;">
      <h2 id="handTitle">æ‰‹æœ­</h2>

      <div class="hand" id="myHand"></div>

      <div class="hintBox">
        <div class="tag">ã‚„ã‚‹ã“ã¨</div>
        <div>
          æ¬¡ã®äººã€Œ<b id="targetNameInline">ç›¸æ‰‹</b>ã€ã®è£ã‚«ãƒ¼ãƒ‰ã‚’<b>1æšã‚¿ãƒƒãƒ—</b>ã—ã¦å¼•ã„ã¦ã­ã€‚
        </div>
      </div>

      <h2>æ¬¡ã®äººã®ã‚«ãƒ¼ãƒ‰ï¼ˆè£ï¼‰</h2>
      <div class="hand" id="opBacks"></div>
    </section>
  </div>

  <script>
    // ========= util =========
    const $ = (id)=>document.getElementById(id);
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
    const shuffle = (a)=>{ for(let i=a.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]]; } return a; };

    function pulseClass(el, cls, ms){
      if(!el) return;
      el.classList.remove(cls);
      void el.offsetWidth;
      el.classList.add(cls);
      setTimeout(()=>el.classList.remove(cls), ms);
    }

    // ========= cards =========
    function makeDeck(){
      const suits = ["S","H","D","C"];
      const ranks = ["A","2","3","4","5","6","7","8","9","10","J","Q","K"];
      const deck=[];
      for(const s of suits) for(const r of ranks) deck.push({suit:s, rank:r});
      deck.push({suit:"J", rank:"Joker"});
      return shuffle(deck);
    }
    function displayCard(c){
      if(c.rank==="Joker") return "ğŸƒJOKER";
      const s = (c.suit==="S"?"â™ ":c.suit==="H"?"â™¥":c.suit==="D"?"â™¦":c.suit==="C"?"â™£":c.suit);
      return s + c.rank;
    }

    function discardPairs(hand){
      // remove pairs by rank (joker excluded)
      const count = new Map();
      for(const c of hand){
        if(c.rank==="Joker") continue;
        count.set(c.rank,(count.get(c.rank)||0)+1);
      }
      const remove = new Map();
      for(const [rank,n] of count.entries()){
        const pairs = Math.floor(n/2);
        if(pairs>0) remove.set(rank, pairs*2);
      }
      if(remove.size===0) return 0;

      const newHand=[];
      let removed=0;
      for(const c of hand){
        if(c.rank==="Joker"){ newHand.push(c); continue; }
        const left = remove.get(c.rank)||0;
        if(left>0){
          remove.set(c.rank, left-1);
          removed++;
        }else{
          newHand.push(c);
        }
      }
      hand.length=0; hand.push(...newHand);
      return removed; // removed cards count
    }

    // ========= game state =========
    let G = null;

    function newGame({players, mode, difficulty}){
      const ps=[];
      ps.push({name:"ã‚ãªãŸ", cpu:false, hand:[]});
      for(let i=2;i<=players;i++){
        const cpu = (mode==="CPU");
        ps.push({name: cpu?`CPU ${i-1}`:`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ${i}`, cpu, hand:[]});
      }

      const deck = makeDeck();
      let idx=0;
      while(deck.length){
        ps[idx].hand.push(deck.pop());
        idx=(idx+1)%ps.length;
      }
      for(const p of ps) discardPairs(p.hand);

      G = {
        mode,
        difficulty,
        players: ps,
        turnIndex: 0,
        finished: false,
        loserName: null,
        message: "æœ€åˆã®ãƒšã‚¢ã‚’æ¨ã¦ã¾ã—ãŸã€‚æ‰‹ç•ªã®äººãŒå¼•ã„ã¦ãã ã•ã„ã€‚",
        locked: (mode==="PVP"),
        busy: false,
        revealOpen: false
      };

      normalizeTurn();
      checkFinish();
      renderAll();
      if(G.mode==="PVP" && G.locked) showLock();
      maybeAutoCpu();
    }

    function current(){ return G.players[G.turnIndex]; }
    function nextIndex(){
      const n=G.players.length;
      for(let step=1; step<=n; step++){
        const i=(G.turnIndex+step)%n;
        if(G.players[i].hand.length>0) return i;
      }
      return (G.turnIndex+1)%n;
    }
    function nextPlayer(){ return G.players[nextIndex()]; }

    function normalizeTurn(){
      const n=G.players.length;
      for(let step=0; step<n; step++){
        if(current().hand.length>0) return;
        G.turnIndex = (G.turnIndex+1)%n;
      }
    }

    function checkFinish(){
      let alive=0, last=null;
      for(const p of G.players){
        if(p.hand.length>0){ alive++; last=p; }
      }
      if(alive<=1){
        G.finished=true;
        G.loserName = last? last.name : "ä¸æ˜";
        G.message = `ã‚²ãƒ¼ãƒ çµ‚äº†ï¼è² ã‘ï¼ˆã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼æŒã¡ï¼‰ã¯ã€Œ${G.loserName}ã€ã§ã™ã€‚`;
      }
    }

    function advanceTurn(){
      const n=G.players.length;
      for(let step=1; step<=n; step++){
        const i=(G.turnIndex+step)%n;
        if(G.players[i].hand.length>0){ G.turnIndex=i; return; }
      }
    }

    function hasRank(hand, rank){
      return hand.some(c=>c.rank!=="Joker" && c.rank===rank);
    }

    function pickIndexByDifficulty(cpuHand, targetHand){
      const n=targetHand.length;
      if(n<=1) return 0;
      const r = ()=> (Math.random()*n)|0;

      if(G.difficulty==="EASY") return r();

      const good=[], nonJoker=[];
      for(let i=0;i<n;i++){
        const c=targetHand[i];
        if(c.rank!=="Joker") nonJoker.push(i);
        if(c.rank!=="Joker" && hasRank(cpuHand, c.rank)) good.push(i);
      }

      if(G.difficulty==="ONI"){
        if(good.length) return good[(Math.random()*good.length)|0];
        if(nonJoker.length) return nonJoker[(Math.random()*nonJoker.length)|0];
        return r();
      }
      if(G.difficulty==="HARD"){
        if(good.length) return good[(Math.random()*good.length)|0];
        return (Math.random()<0.9)?0:r();
      }
      // NORMAL
      return r();
    }

    // ========= animation helpers =========
    async function playDrawAnimation(fromEl, toEl){
      pulseClass($("ch-me"), "reach", 480);
      pulseClass($("ch-next"), "react", 320);

      const fly = $("flyCard");
      if(!fly || !fromEl || !toEl) return;

      const fr = fromEl.getBoundingClientRect();
      const tr = toEl.getBoundingClientRect();

      const startX = fr.left + fr.width/2;
      const startY = fr.top  + fr.height/2;
      const targetX = tr.left + Math.min(tr.width*0.5, 240);
      const targetY = tr.top  + Math.min(tr.height*0.5, 80);

      const dx = (targetX - startX);
      const dy = (targetY - startY);

      fly.style.left = (startX - fly.offsetWidth/2) + "px";
      fly.style.top  = (startY - fly.offsetHeight/2) + "px";
      fly.style.setProperty("--dx", dx+"px");
      fly.style.setProperty("--dy", dy+"px");

      fly.classList.remove("play");
      void fly.offsetWidth;
      fly.classList.add("play");

      await new Promise(res=>setTimeout(res, 500));
    }

    // âœ… è¿½åŠ ï¼šå¼•ã„ãŸã‚«ãƒ¼ãƒ‰ã®ç¢ºèªï¼ˆOKã‚’æŠ¼ã™ã¾ã§é€²è¡Œã—ãªã„ï¼‰
    function showReveal(cardText, matched, onOk){
      if(!G || G.revealOpen) return;
      G.revealOpen = true;

      const ov = $("revealOverlay");
      const inner = $("revealInner");

      // è¡¨ç¤ºå†…å®¹
      $("revealCardText").textContent = cardText;
      $("revealResultText").innerHTML = matched
        ? `âœ… <b>ãã‚ã£ãŸï¼</b>ï¼ˆãƒšã‚¢ãŒã§ãã¾ã™ï¼‰`
        : `âŒ <b>ãã‚ã£ã¦ãªã„</b>`;

      // è¡¨â†’è£ã®å›è»¢ã‚’æ¯å›ãƒªã‚»ãƒƒãƒˆã—ã¦ã‹ã‚‰è¡¨ç¤º
      ov.classList.add("hidden");
      ov.classList.remove("show");
      inner.style.transition = "none";
      inner.style.transform = "rotateY(180deg)";
      void inner.offsetWidth;
      inner.style.transition = "";
      inner.style.transform = "";

      // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤º
      ov.classList.remove("hidden");
      ov.setAttribute("aria-hidden","false");
      ov.classList.add("show");

      // OKãƒœã‚¿ãƒ³
      const btn = $("revealOkBtn");
      btn.onclick = null;
      btn.onclick = () => {
        ov.classList.add("hidden");
        ov.setAttribute("aria-hidden","true");
        ov.classList.remove("show");
        G.revealOpen = false;
        onOk();
      };
    }

    // ========= actions =========
    async function humanDraw(chosenIndex, clickedBtn){
      if(!G || G.busy || G.finished) return;
      if(G.mode==="PVP" && G.locked) return;
      if(current().cpu) return;

      const me = current();
      const target = nextPlayer();
      if(target.hand.length===0){
        G.message = "æ¬¡ã®äººãŒ0æšãªã®ã§è‡ªå‹•ã§æ¬¡ã¸ã€‚";
        advanceTurn(); normalizeTurn();
        renderAll();
        maybeAutoCpu();
        return;
      }

      G.busy = true;

      // â‘  æ¼”å‡º
      const toEl = $("myHand");
      await playDrawAnimation(clickedBtn, toEl);

      // â‘¡ å¼•ãï¼ˆã“ã“ã§ã¯æ¨ã¦ãªã„ï¼‰
      const idx = clamp(chosenIndex, 0, target.hand.length-1);
      const taken = target.hand.splice(idx, 1)[0];
      const matched = (taken.rank !== "Joker") && hasRank(me.hand, taken.rank);
      me.hand.push(taken);

      // â‘¢ å¼•ã„ãŸã‚«ãƒ¼ãƒ‰ã‚’ç¢ºèª â†’ OKå¾Œã«æ¨ã¦ï¼†æ¬¡ã®ç•ª
      showReveal(displayCard(taken), matched, () => {
        const removed = discardPairs(me.hand);

        G.message =
          `${me.name} ãŒ ${target.name} ã‹ã‚‰1æšå¼•ã„ãŸï¼` +
          (matched ? "ï¼ˆãã‚ã£ãŸï¼ï¼‰" : "ï¼ˆãã‚ã£ã¦ãªã„ï¼‰") +
          (removed>0 ? ` ãƒšã‚¢ã‚’${removed/2}çµ„æ¨ã¦ãŸï¼` : "");

        checkFinish();
        if(!G.finished){
          advanceTurn();
          normalizeTurn();
        }

        // PVPï¼šå¼•ã„ãŸã‚‰ãƒ­ãƒƒã‚¯ã—ã¦ç«¯æœ«ã‚’æ¸¡ã™
        if(G.mode==="PVP" && !G.finished){
          G.locked = true;
        }

        G.busy = false;
        renderAll();

        if(G.mode==="PVP" && G.locked && !G.finished){
          showLock();
        }

        maybeAutoCpu();
      });
    }

    async function cpuStep(){
      if(!G || G.busy || G.finished) return;
      if(!current().cpu) return;

      G.busy=true;
      $("cpuPanel").style.display = "";
      $("cpuThinking").textContent = "CPUãŒè€ƒãˆä¸­...";

      await new Promise(r=>setTimeout(r, 700));

      const cpu = current();
      const target = nextPlayer();
      if(target.hand.length===0){
        G.message = `${cpu.name} ã¯æ¬¡ã®äººãŒ0æšãªã®ã§ã‚¹ã‚­ãƒƒãƒ—ã€‚`;
        advanceTurn(); normalizeTurn();
        G.busy=false;
        renderAll();
        maybeAutoCpu();
        return;
      }

      // æ¼”å‡ºï¼šè£ã‚«ãƒ¼ãƒ‰ã£ã½ã„è¦ç´ ã‹ã‚‰é£›ã°ã™
      const backs = $("opBacks").querySelector(".card.back");
      const toEl = $("myHand");
      await playDrawAnimation(backs || $("opBacks"), toEl);

      const pick = pickIndexByDifficulty(cpu.hand, target.hand);
      const idx = clamp(pick, 0, target.hand.length-1);
      const taken = target.hand.splice(idx, 1)[0];
      const matched = (taken.rank !== "Joker") && hasRank(cpu.hand, taken.rank);
      cpu.hand.push(taken);

      // CPUã‚‚ã€Œç¢ºèªã€ã‚’å‡ºã™ï¼ˆOKã¯è‡ªå‹•ã§æŠ¼ã™ï¼‰
      showReveal(displayCard(taken), matched, () => {
        const removed = discardPairs(cpu.hand);

        G.message =
          `${cpu.name} ãŒ ${target.name} ã‹ã‚‰1æšå¼•ã„ãŸã€‚` +
          (matched ? "ï¼ˆãã‚ã£ãŸï¼‰" : "ï¼ˆãã‚ã£ã¦ãªã„ï¼‰") +
          (removed>0 ? ` ãƒšã‚¢ã‚’${removed/2}çµ„æ¨ã¦ãŸã€‚` : "");

        checkFinish();
        if(!G.finished){
          advanceTurn(); normalizeTurn();
        }

        G.busy=false;
        renderAll();
        maybeAutoCpu();
      });

      // CPUã®ç¢ºèªã¯ 900ms ã§è‡ªå‹•OK
      setTimeout(() => {
        if(G && G.revealOpen){
          const btn = $("revealOkBtn");
          btn && btn.click();
        }
      }, 900);
    }

    function maybeAutoCpu(){
      if(!G || G.finished) return;
      if(G.mode==="CPU" && current().cpu && !G.locked){
        setTimeout(cpuStep, 50);
      }
    }

    // ========= render =========
    function showMenu(){
      $("viewMenu").classList.remove("hidden");
      $("viewGame").classList.add("hidden");
      hideLock();
    }
    function showGame(){
      $("viewMenu").classList.add("hidden");
      $("viewGame").classList.remove("hidden");
    }

    function showLock(){
      $("lockText").innerHTML = `æ‰‹ç•ªï¼š<b>${escapeHtml(current().name)}</b><br>æº–å‚™ã§ããŸã‚‰ã€Œè§£é™¤ã€ã‚’æŠ¼ã—ã¦ã­ã€‚`;
      $("lockOverlay").classList.remove("hidden");
      $("lockOverlay").setAttribute("aria-hidden","false");
    }
    function hideLock(){
      $("lockOverlay").classList.add("hidden");
      $("lockOverlay").setAttribute("aria-hidden","true");
    }

    function renderStatus(){
      const grid = $("statusGrid");
      grid.innerHTML="";
      const n=G.players.length;
      for(let i=0;i<n;i++){
        const p=G.players[i];
        const div=document.createElement("div");
        div.className="pStat";
        div.innerHTML = `
          <div class="pName">${escapeHtml(p.name)}${i===G.turnIndex?"ï¼ˆæ‰‹ç•ªï¼‰":""}</div>
          <div class="pMeta">æ‰‹æœ­ <b>${p.hand.length}</b> æš</div>
        `;
        grid.appendChild(div);
      }
    }

    function renderCharacters(){
      $("meName").textContent = current().name;
      $("nextName").textContent = nextPlayer().name;
      $("meState").textContent = current().cpu ? "CPUï¼ˆè‡ªå‹•ï¼‰" : "äººé–“ï¼ˆæ“ä½œï¼‰";
      $("nextState").textContent = "æ¬¡ã«å¼•ãç›¸æ‰‹";
      $("ch-me").classList.add("idle");
      $("ch-next").classList.add("idle");
    }

    function renderHumanArea(){
      const isHumanTurn = !G.finished && !current().cpu && !(G.mode==="PVP" && G.locked);
      const isCpuTurn   = !G.finished && current().cpu && !(G.mode==="PVP" && G.locked);

      $("humanPanel").style.display = isHumanTurn ? "" : "none";
      $("cpuPanel").style.display   = isCpuTurn ? "" : "none";

      $("handTitle").textContent = `${current().name} ã®æ‰‹æœ­ï¼ˆè¦‹ãˆã‚‹ï¼‰`;
      $("targetNameInline").textContent = nextPlayer().name;

      const myHand=$("myHand");
      myHand.innerHTML="";
      for(const c of current().hand){
        const d=document.createElement("div");
        d.className="card faceUp";
        d.innerHTML=`<div class="rank">${escapeHtml(displayCard(c))}</div>`;
        myHand.appendChild(d);
      }

      const backs=$("opBacks");
      backs.innerHTML="";
      const t = nextPlayer();
      for(let i=0;i<t.hand.length;i++){
        const b=document.createElement("div");
        b.className="card back";
        b.innerHTML=`<span class="backMark">ğŸ‚ </span>`;
        b.dataset.idx = String(i);
        b.addEventListener("click", (ev)=>{
          ev.preventDefault();
          if(G.busy) return;
          // å¤šé‡ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢
          b.style.pointerEvents="none";
          setTimeout(()=>b.style.pointerEvents="", 900);
          humanDraw(i, b);
        });
        backs.appendChild(b);
      }
    }

    function renderResult(){
      if(G.finished){
        $("resultPanel").style.display="";
        $("resultText").innerHTML = `è² ã‘ï¼ˆã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼æŒã¡ï¼‰ï¼š<b>${escapeHtml(G.loserName)}</b>`;
      }else{
        $("resultPanel").style.display="none";
      }
    }

    function renderAll(){
      if(!G) return;
      showGame();
      $("subTitle").textContent = `ãƒ¢ãƒ¼ãƒ‰ï¼š${G.mode} / å¼·ã•ï¼š${G.difficulty}`;
      $("msgBox").textContent = G.message;

      renderStatus();
      renderCharacters();
      renderResult();
      renderHumanArea();

      $("lockNowBtn").style.display = (G.mode==="PVP" && !G.finished) ? "" : "none";

      if(G.mode==="PVP" && G.locked && !G.finished){
        showLock();
      }else{
        hideLock();
      }
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    // ========= menu events / persistence =========
    function loadSettings(){
      try{
        const raw = localStorage.getItem("babanuki_settings");
        if(!raw) return;
        const s = JSON.parse(raw);
        if(s.players) $("playersSel").value = String(s.players);
        if(s.mode) $("modeSel").value = s.mode;
        if(s.diff) $("diffSel").value = s.diff;
      }catch(_){}
    }
    function saveSettings(){
      const s = {
        players: Number($("playersSel").value),
        mode: $("modeSel").value,
        diff: $("diffSel").value
      };
      localStorage.setItem("babanuki_settings", JSON.stringify(s));
    }

    $("startBtn").addEventListener("click", ()=>{
      saveSettings();
      newGame({
        players: Number($("playersSel").value),
        mode: $("modeSel").value,
        difficulty: $("diffSel").value
      });
    });

    $("menuBtn").addEventListener("click", ()=>{
      G=null;
      showMenu();
    });

    $("restartBtn").addEventListener("click", ()=>{
      const last = JSON.parse(localStorage.getItem("babanuki_settings")||"{}");
      newGame({
        players: Number(last.players||4),
        mode: last.mode||"CPU",
        difficulty: last.diff||"NORMAL"
      });
    });

    $("unlockBtn").addEventListener("click", ()=>{
      if(!G) return;
      G.locked=false;
      hideLock();
      renderAll();
      maybeAutoCpu();
    });

    $("lockNowBtn").addEventListener("click", ()=>{
      if(!G || G.mode!=="PVP" || G.finished) return;
      G.locked=true;
      showLock();
    });

    // init
    loadSettings();
    showMenu();
  </script>
</body>
</html>
